<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Firmas y Cargos v2.1 (Resumen)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.8"></script>
    <!-- ¡NUEVAS LIBRERÍAS PARA EXPORTAR! -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* --- Estilos existentes sin cambios --- */
        * { margin:0; padding:0; box-sizing:border-box; }
        html { height: 100%; }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #0f0f0f;
            color: #e0e0e0;
            min-height: 100%;
            padding: 20px;
        }
        .container { width: 100%; max-width: 960px; margin: 0 auto; padding: 1rem; }
        h1, h2, h3, h4 { color: #d4af37; margin-bottom: 1rem; }
        .card { background: #1a1a1a; border-radius: 12px; padding: 2.5rem; box-shadow: 0 8px 30px rgba(0,0,0,0.6 ); margin: 1.5rem 0; }
        input, textarea { width: 100%; padding: 12px; margin: 10px 0; background: #2a2a2a; border: 1px solid #444; border-radius: 6px; color: #e0e0e0; font-size: 1rem; }
        button {
            background: #d4af37; color: #0f0f0f; border: none;
            padding: 14px 28px; margin: 8px 4px; border-radius: 8px;
            font-weight: bold; cursor: pointer; font-size: 1.1rem;
            transition: all 0.2s; flex-grow: 1; max-width: 300px;
        }
        button:hover { background: #b8972e; transform: translateY(-2px); }
        button.secondary { background: #444; color: #e0e0e0; }
        button.secondary:hover { background: #555; }
        button.danger { background: #b71c1c; color: white; }
        button.danger:hover { background: #c62828; }
        .buttons { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; width: 100%; }
        .hidden { display: none !important; }
        .item { background: #222; padding: 1.5rem; border-radius: 10px; margin: 1.5rem 0; border-left: 4px solid #d4af37; transition: background-color 0.2s; position: relative; }
        .item.editable:hover { background-color: #333; cursor: pointer; }
        .flex-center { display: flex; justify-content: center; align-items: center; flex-direction: column; }
        #mensaje { margin-top: 1rem; font-weight: bold; }
        canvas { border: 2px solid #444; background: #f8f8f8; border-radius: 8px; margin: 12px 0; touch-action: none; width: 100%; max-width: 500px; height: 280px; box-shadow: inset 0 2px 6px rgba(0,0,0,0.1); }
        .folder-info { border-bottom: 1px solid #444; padding-bottom: 1.5rem; margin-bottom: 1.5rem; }
        .signatures-display { display: flex; justify-content: space-around; align-items: center; text-align: center; margin-top: 1rem; flex-wrap: wrap; gap: 20px; }
        .signature-box { border: 1px solid #333; padding: 15px; border-radius: 8px; width: 250px; }
        .signature-box h5 { color: #aaa; margin-bottom: 10px; }
        .signature-box img { max-height: 80px; width: auto; background-color: white; padding: 5px; border-radius: 4px; margin-top: 5px; }
        .signature-box p { color: #888; font-style: italic; }
        .signature-box .signer-name { color: #d4af37; font-weight: bold; height: 20px; }
        .folder-list-container { max-height: 400px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; padding-right: 10px; }
        .folder-list-item { background: #2a2a2a; padding: 15px 20px; border-radius: 8px; border-left: 4px solid #d4af37; cursor: pointer; transition: background-color 0.2s, border-color 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .folder-list-item:hover { background-color: #333; border-color: #b8972e; }
        .folder-name { font-weight: 600; font-size: 1.1rem; }
        .folder-date { font-size: 0.9rem; color: #aaa; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); justify-content: center; align-items: center; }
        .modal-content { background: #1a1a1a; margin: auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .modal-content textarea { height: 120px; }
        .delete-item-btn { position: absolute; top: 10px; right: 10px; background: #616161; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 16px; font-weight: bold; cursor: pointer; display: flex; justify-content: center; align-items: center; padding: 0; margin: 0; line-height: 1; }
        .delete-item-btn:hover { background: #757575; }

        /* --- ¡NUEVOS ESTILOS PARA EL RESUMEN! --- */
        #summary-view {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            overflow-y: auto;
            padding: 20px;
        }
        .summary-page {
            background: white;
            width: 210mm;
            min-height: 297mm;
            padding: 20mm;
            margin: 20px auto;
            color: #333;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }
        .summary-page h1 { color: #333; text-align: center; }
        .summary-table { width: 100%; border-collapse: collapse; font-size: 9pt; margin-top: 20px; }
        .summary-table th, .summary-table td { border: 1px solid #ccc; padding: 6px; text-align: left; vertical-align: middle; }
        .summary-table th { background: #f2f2f2; }
        .summary-table img { max-height: 30px; vertical-align: middle; background: #fff; }
        .summary-table .signer-info { display: flex; align-items: center; gap: 8px; }
        .summary-table .signer-name { font-size: 8pt; color: #555; }
        .page-break { page-break-after: always; }
        #summary-controls { position: fixed; top: 20px; right: 20px; z-index: 2001; }
    </style>
</head>
<body>

<div class="container">
    <!-- HTML sin cambios estructurales -->
    <div id="login-section" class="card flex-center">...</div>
    <div id="dashboard" class="hidden">
        <div class="card flex-center">
            <h1>Bienvenido, <span id="username" style="color:#d4af37;"></span></h1>
            <div class="buttons">
                <button onclick="showCreateFolder()">Crear Nueva Carpeta</button>
                <button onclick="loadFolders()">Consultar Carpetas</button>
                <!-- ¡NUEVO BOTÓN! -->
                <button class="secondary" onclick="generateSummary()">Resumen</button>
                <button class="danger" onclick="handleLogout()">Cerrar Sesión</button>
            </div>
        </div>
        <div id="folders-list" class="card" style="display:none;"></div>
    </div>
    <div id="create-folder" class="hidden">...</div>
    <div id="view-folder" class="hidden">...</div>
    <div id="observation-modal" class="modal">...</div>
</div>

<!-- ¡NUEVA VISTA PARA EL RESUMEN! -->
<div id="summary-view">
    <div id="summary-controls">
        <button id="export-pdf-btn">Exportar PDF</button>
        <button id="export-jpg-btn">Exportar JPG</button>
        <button class="danger" onclick="document.getElementById('summary-view').style.display='none'">Cerrar</button>
    </div>
    <div id="summary-content"></div>
</div>

<script>
    // --- Lógica de Supabase y variables globales (sin cambios) ---
    const SUPABASE_URL = 'https://esiklpxyectbekxvajnw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVzaWtscHh5ZWN0YmVreHZham53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2OTI1MjEsImV4cCI6MjA3NzI2ODUyMX0.mtQnqUrTmhmN1DQxOAUnGpizhYZobStHDH0cz_XfKGU';
    let supabaseClient = null;
    let currentUser = null;
    let items = [];

    // --- Todas las funciones hasta la última permanecen intactas ---
    function getSupabase( ) { /* ... */ }
    window.onload = () => { /* ... */ };
    function showLogin() { /* ... */ }
    async function handleLogin() { /* ... */ }
    function handleLogout() { /* ... */ }
    function showDashboard() { /* ... */ }
    function showCreateFolder() { /* ... */ }
    function addItemField() { /* ... */ }
    function removeItemField(indexToRemove) { /* ... */ }
    async function createFolderAndItems() { /* ... */ }
    async function loadFolders() { /* ... */ }
    async function loadFolder(carpeta) { /* ... */ }
    function showEditObservationModal(itemId, currentObservation) { /* ... */ }
    function closeObservationModal() { /* ... */ }
    async function saveObservation(itemId) { /* ... */ }
    async function saveFolderSignature(carpeta, role) { /* ... */ }
    function initCanvas(idx) { /* ... */ }
    function clearCanvas(idx) { /* ... */ }
    function dataURLtoBlob(dataurl) { /* ... */ }
    function backToDashboard() { /* ... */ }

    // =================================================================
    // --- ¡NUEVA FUNCIÓN!: generateSummary() ---
    // =================================================================
    async function generateSummary() {
        const supabase = getSupabase(); if (!supabase) return;
        const summaryView = document.getElementById('summary-view');
        const summaryContent = document.getElementById('summary-content');
        
        summaryContent.innerHTML = '<h1>Generando resumen...</h1>';
        summaryView.style.display = 'block';

        const { data, error } = await supabase
            .from('firmas_cargos')
            .select('*')
            .order('carpeta', { ascending: true })
            .order('fecha', { ascending: true });

        if (error) {
            summaryContent.innerHTML = `<h1 style="color:red;">Error: ${error.message}</h1>`;
            return;
        }

        if (!data || data.length === 0) {
            summaryContent.innerHTML = '<h1>No hay datos para mostrar.</h1>';
            return;
        }

        let html = '';
        let currentPage = 1;
        let itemsOnPage = 0;

        html += `<div class="summary-page"><h1>Resumen de Cargos</h1><table class="summary-table">`;
        html += `<thead><tr><th>N°</th><th>Carpeta</th><th>Item</th><th>Fecha Creación</th><th>Firma Recepción</th><th>Firma Receptor</th></tr></thead><tbody>`;

        data.forEach((item, index) => {
            if (itemsOnPage === 10) {
                html += `</tbody></table></div>`; // Cierra la tabla y la página actual
                html += `<div class="summary-page page-break"><h1>Resumen de Cargos (pág. ${++currentPage})</h1><table class="summary-table">`; // Abre nueva página y tabla
                html += `<thead><tr><th>N°</th><th>Carpeta</th><th>Item</th><th>Fecha Creación</th><th>Firma Recepción</th><th>Firma Receptor</th></tr></thead><tbody>`;
                itemsOnPage = 0;
            }

            const fecha = new Date(item.fecha).toLocaleDateString('es-ES');
            const firmaRecepcionHTML = item.firma_recepcion_url 
                ? `<div class="signer-info"><img src="${item.firma_recepcion_url}"><span class="signer-name">${item.nombre_recepcion || ''}</span></div>` 
                : 'Pendiente';
            const firmaReceptorHTML = item.firma_receptor_url 
                ? `<div class="signer-info"><img src="${item.firma_receptor_url}"><span class="signer-name">${item.nombre_receptor || ''}</span></div>` 
                : 'Pendiente';

            html += `
                <tr>
                    <td>${index + 1}</td>
                    <td>${item.carpeta}</td>
                    <td>${item.item}</td>
                    <td>${fecha}</td>
                    <td>${firmaRecepcionHTML}</td>
                    <td>${firmaReceptorHTML}</td>
                </tr>
            `;
            itemsOnPage++;
        });

        html += `</tbody></table></div>`; // Cierra la última tabla y página
        summaryContent.innerHTML = html;
    }

    // =================================================================
    // --- ¡NUEVA LÓGICA PARA LOS BOTONES DE EXPORTACIÓN! ---
    // =================================================================
    document.getElementById('export-pdf-btn').addEventListener('click', () => {
        const { jsPDF } = window.jspdf;
        const content = document.getElementById('summary-content');
        const pdf = new jsPDF('p', 'mm', 'a4');
        
        html2canvas(content, { scale: 2, windowWidth: content.scrollWidth, windowHeight: content.scrollHeight }).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const imgWidth = 210; // A4 width in mm
            const pageHeight = 295; // A4 height in mm
            const imgHeight = canvas.height * imgWidth / canvas.width;
            let heightLeft = imgHeight;
            let position = 0;

            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;

            while (heightLeft > 0) {
                position = heightLeft - imgHeight;
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
            }
            pdf.save('resumen_cargos.pdf');
        });
    });

    document.getElementById('export-jpg-btn').addEventListener('click', () => {
        const content = document.getElementById('summary-content');
        html2canvas(content, { scale: 2, windowWidth: content.scrollWidth, windowHeight: content.scrollHeight }).then(canvas => {
            const link = document.createElement('a');
            link.download = 'resumen_cargos.jpg';
            link.href = canvas.toDataURL('image/jpeg', 0.9);
            link.click();
        });
    });

</script>
</body>
</html>
