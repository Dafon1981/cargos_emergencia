<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista Firma Cargos v2.6</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Librería para el canvas de firma -->
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; 
            margin: 20px; 
            background-color: #f4f7f6; 
            color: #333;
        }
        .container { 
            max-width: 800px; 
            margin: auto; 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1 ); 
        }
        h1, h2 { 
            color: #333; 
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }
        button { 
            background-color: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 15px; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 16px; 
            margin: 5px; 
            transition: background-color 0.3s;
        }
        button:hover { 
            background-color: #0056b3; 
        }
        button:disabled { 
            background-color: #ccc; 
            cursor: not-allowed;
        }
        input, select { 
            padding: 10px; 
            margin: 5px 0; 
            border-radius: 5px; 
            border: 1px solid #ccc; 
            width: calc(100% - 22px); 
            box-sizing: border-box;
        }
        .hidden { 
            display: none; 
        }
        .folder-list, .file-list { 
            list-style: none; 
            padding: 0; 
        }
        .folder-list li, .file-list li { 
            background: #e9ecef; 
            padding: 15px; 
            margin-bottom: 10px; 
            border-radius: 5px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .folder-list li:hover {
            background-color: #d8dde2;
        }
        .canvas-container { 
            border: 1px solid #ccc; 
            margin-top: 10px; 
            padding: 10px;
            border-radius: 5px;
        }
        canvas { 
            touch-action: none; 
            width: 100%;
            height: 200px;
            border: 1px dashed #ddd;
        }
        #summary-page { 
            border: 1px solid #000; 
            padding: 20px; 
            margin-top: 20px; 
            background: white; 
        }
        #filter-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }
        .mensaje-inicial {
            text-align: center;
            padding: 50px 20px;
            color: #777;
            font-size: 1.2em;
            border: 2px dashed #ddd;
            border-radius: 8px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Gestión de Firma de Cargos</h1>

        <!-- Vista Principal -->
        <div id="main-view">
            <h2>Folders de Cargos</h2>
            <button id="create-folder-btn">Crear Nuevo Folder</button>
            <button id="summary-btn">Ver Resumen</button>
            <ul id="folder-list" class="folder-list"></ul>
        </div>

        <!-- Vista de Carga de Archivos -->
        <div id="upload-view" class="hidden">
            <h2 id="upload-view-title"></h2>
            <input type="file" id="file-input" multiple accept="image/*">
            <button id="upload-btn">Subir Archivos</button>
            <button class="back-to-main">Volver</button>
            <h3>Archivos en este folder:</h3>
            <ul id="file-list" class="file-list"></ul>
            <div id="signature-section" class="hidden">
                <h3>Firmas de Recepción</h3>
                <div class="canvas-container">
                    <p>Firma 1:</p>
                    <canvas id="signature-canvas-1"></canvas>
                    <button onclick="clearCanvas('signature-canvas-1')">Limpiar</button>
                </div>
                <div class="canvas-container">
                    <p>Firma 2:</p>
                    <canvas id="signature-canvas-2"></canvas>
                    <button onclick="clearCanvas('signature-canvas-2')">Limpiar</button>
                </div>
                <button id="save-signatures-btn">Guardar Firmas y Finalizar</button>
            </div>
        </div>

        <!-- Vista de Resumen -->
        <div id="summary-view" class="hidden">
            <h2>Resumen de Cargos</h2>
            <div id="filter-section">
                <label for="user-filter">Recepción (Usuario):</label>
                <select id="user-filter"><option value="">Todos</option></select>
                <label for="start-date-filter">Desde:</label>
                <input type="date" id="start-date-filter">
                <label for="end-date-filter">Hasta:</label>
                <input type="date" id="end-date-filter">
                <label for="doc-type-filter">Tipo Doc:</label>
                <select id="doc-type-filter">
                    <option value="">Todos</option>
                    <option value="Cargo">Cargo</option>
                    <option value="Otro">Otro</option>
                </select>
                <button id="apply-filters-btn">Generar Impresión</button>
            </div>
            <div id="summary-results">
                <div class="mensaje-inicial">
                    <p>Por favor, aplique un filtro para generar el resumen de impresión.</p>
                </div>
            </div>
            <button class="back-to-main">Volver al Menú Principal</button>
        </div>
    </div>

<script>
    const SUPABASE_URL = 'https://esiklpxyectbekxvajnw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVzaWtscHh5ZWN0YmVreHZham53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2OTI1MjEsImV4cCI6MjA3NzI2ODUyMX0.mtQnqUrTmhmN1DQxOAUnGpizhYZobStHDH0cz_XfKGU';
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY );

    let currentFolderId = null;
    let signaturePad1, signaturePad2;

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('create-folder-btn').addEventListener('click', createFolder);
        document.getElementById('summary-btn').addEventListener('click', openSummaryView);
        document.querySelectorAll('.back-to-main').forEach(btn => btn.addEventListener('click', showMainView));
        document.getElementById('upload-btn').addEventListener('click', uploadFiles);
        document.getElementById('save-signatures-btn').addEventListener('click', saveSignatures);
        document.getElementById('apply-filters-btn').addEventListener('click', generateSummary);

        loadFolders();
        populateUserFilter();
    });
    function showView(viewId) {
        ['main-view', 'upload-view', 'summary-view'].forEach(id => {
            document.getElementById(id).classList.add('hidden');
        });
        document.getElementById(viewId).classList.remove('hidden');
    }

    function showMainView() {
        showView('main-view');
        loadFolders();
    }

    async function loadFolders() {
        const { data, error } = await supabaseClient.from('firma_cargos').select('*').order('created_at', { ascending: false });
        if (error) { console.error('Error loading folders:', error); return; }
        const list = document.getElementById('folder-list');
        list.innerHTML = '';
        data.forEach(folder => {
            const item = document.createElement('li');
            item.innerHTML = `<span>${folder.nombre}</span> <span>${new Date(folder.created_at).toLocaleDateString()}</span>`;
            item.onclick = () => openUploadView(folder.id, folder.nombre);
            list.appendChild(item);
        });
    }

    async function createFolder() {
        const user = prompt("Ingrese su nombre de usuario (Recepción):");
        if (!user || user.trim() === '') {
            alert("El nombre de usuario es obligatorio.");
            return;
        }
        const folderName = `Cargo_${new Date().toISOString().split('T')[0]}_${user.trim()}`;
        const { data, error } = await supabaseClient.from('firma_cargos').insert([{ nombre: folderName, usuario: user.trim() }]).select();
        if (error) { console.error('Error creating folder:', error); return; }
        loadFolders();
    }

    function openUploadView(folderId, folderName) {
        currentFolderId = folderId;
        document.getElementById('upload-view-title').textContent = `Folder: ${folderName}`;
        showView('upload-view');
        loadFiles(folderId);
        setupCanvases();
    }

    async function loadFiles(folderId) {
        const { data, error } = await supabaseClient.storage.from('firma_cargos').list(folderId.toString());
        if (error) { console.error('Error loading files:', error); return; }
        const list = document.getElementById('file-list');
        list.innerHTML = '';
        data.forEach(file => {
            const item = document.createElement('li');
            item.textContent = file.name;
            list.appendChild(item);
        });
        if (data.length > 0) {
            document.getElementById('signature-section').classList.remove('hidden');
        }
    }

    async function uploadFiles() {
        const files = document.getElementById('file-input').files;
        if (files.length === 0) { alert('Seleccione al menos un archivo.'); return; }
        const uploadBtn = document.getElementById('upload-btn');
        uploadBtn.disabled = true;
        uploadBtn.textContent = 'Subiendo...';
        for (const file of files) {
            const { error } = await supabaseClient.storage.from('firma_cargos').upload(`${currentFolderId}/${file.name}`, file);
            if (error) { console.error('Error uploading file:', error); alert(`Error al subir ${file.name}`); }
        }
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'Subir Archivos';
        loadFiles(currentFolderId);
    }

    function setupCanvases() {
        const canvas1 = document.getElementById('signature-canvas-1');
        const canvas2 = document.getElementById('signature-canvas-2');
        
        // Ajustar tamaño del canvas al contenedor
        function resizeCanvas(canvas) {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
        }
        
        resizeCanvas(canvas1);
        resizeCanvas(canvas2);

        signaturePad1 = new SignaturePad(canvas1);
        signaturePad2 = new SignaturePad(canvas2);
    }

    function clearCanvas(canvasId) {
        if (canvasId === 'signature-canvas-1') signaturePad1.clear();
        if (canvasId === 'signature-canvas-2') signaturePad2.clear();
    }

    async function saveSignatures() {
        if (signaturePad1.isEmpty() || signaturePad2.isEmpty()) { alert('Ambas firmas son requeridas.'); return; }
        const saveBtn = document.getElementById('save-signatures-btn');
        saveBtn.disabled = true;
        saveBtn.textContent = 'Guardando...';

        const sig1 = signaturePad1.toDataURL();
        const sig2 = signaturePad2.toDataURL();
        const { error: err1 } = await supabaseClient.storage.from('firma_cargos').upload(`${currentFolderId}/firma1.png`, dataURLToBlob(sig1), { upsert: true });
        const { error: err2 } = await supabaseClient.storage.from('firma_cargos').upload(`${currentFolderId}/firma2.png`, dataURLToBlob(sig2), { upsert: true });
        
        saveBtn.disabled = false;
        saveBtn.textContent = 'Guardar Firmas y Finalizar';

        if (err1 || err2) { console.error('Error saving signatures:', err1 || err2); alert('Error al guardar las firmas.'); return; }
        alert('Firmas guardadas correctamente.');
        showMainView();
    }

    function dataURLToBlob(dataURL) {
        const parts = dataURL.split(';base64,');
        const contentType = parts[0].split(':')[1];
        const raw = window.atob(parts[1]);
        const rawLength = raw.length;
        const uInt8Array = new Uint8Array(rawLength);
        for (let i = 0; i < rawLength; ++i) {
            uInt8Array[i] = raw.charCodeAt(i);
        }
        return new Blob([uInt8Array], { type: contentType });
    }

    async function populateUserFilter() {
        const { data, error } = await supabaseClient.from('usuarios').select('usuario').order('usuario');
        if (error) { console.error('Error populating user filter:', error); return; }
        const select = document.getElementById('user-filter');
        // Limpiar opciones existentes excepto la primera ("Todos")
        select.innerHTML = '<option value="">Todos</option>';
        data.forEach(user => {
            const option = document.createElement('option');
            option.value = user.usuario;
            option.textContent = user.usuario;
            select.appendChild(option);
        });
    }

    function openSummaryView() {
        showView('summary-view');
        const resultsContainer = document.getElementById('summary-results');
        resultsContainer.innerHTML = `
            <div class="mensaje-inicial">
                <p>Por favor, aplique un filtro para generar el resumen de impresión.</p>
            </div>
        `;
    }

    async function generateSummary() {
        const resultsContainer = document.getElementById('summary-results');
        resultsContainer.innerHTML = '<p>Generando resumen, por favor espere...</p>';

        const userFilter = document.getElementById('user-filter').value;
        const startDateFilter = document.getElementById('start-date-filter').value;
        const endDateFilter = document.getElementById('end-date-filter').value;

        let query = supabaseClient.from('firma_cargos').select('*');
        if (userFilter) query = query.eq('usuario', userFilter);
        if (startDateFilter) query = query.gte('created_at', startDateFilter);
        if (endDateFilter) {
            const nextDay = new Date(endDateFilter);
            nextDay.setDate(nextDay.getDate() + 1);
            query = query.lt('created_at', nextDay.toISOString().split('T')[0]);
        }
        query = query.order('created_at', { ascending: false });

        const { data: folders, error } = await query;
        if (error) { resultsContainer.innerHTML = `<p style="color:red;">Error: ${error.message}</p>`; return; }
        if (folders.length === 0) { resultsContainer.innerHTML = '<p>No se encontraron cargos con los filtros aplicados.</p>'; return; }

        resultsContainer.innerHTML = ''; 

        for (const folder of folders) {
            const page = document.createElement('div');
            page.className = 'summary-page';
            page.style.border = '1px solid #000';
            page.style.padding = '20px';
            page.style.margin = '20px 0';
            page.style.background = 'white';

            page.innerHTML = `<h3>Resumen de Cargo: ${folder.nombre}</h3><p>Usuario: ${folder.usuario}</p><p>Fecha: ${new Date(folder.created_at).toLocaleString()}</p>`;
            
            const { data: files, error: filesError } = await supabaseClient.storage.from('firma_cargos').list(folder.id.toString());
            if (filesError) continue;

            const imageFiles = files.filter(f => f.name !== 'firma1.png' && f.name !== 'firma2.png');
            const firma1File = files.find(f => f.name === 'firma1.png');
            const firma2File = files.find(f => f.name === 'firma2.png');

            page.innerHTML += '<h4>Imágenes del Cargo:</h4>';
            for (const file of imageFiles) {
                const { data: urlData } = supabaseClient.storage.from('firma_cargos').getPublicUrl(`${folder.id}/${file.name}`);
                page.innerHTML += `<img src="${urlData.publicUrl}" width="200" style="margin:5px; border: 1px solid #ddd;">`;
            }

            page.innerHTML += '<h4>Firmas:</h4>';
            if (firma1File) {
                const { data: urlData } = supabaseClient.storage.from('firma_cargos').getPublicUrl(`${folder.id}/firma1.png`);
                page.innerHTML += `<img src="${urlData.publicUrl}" width="200" style="border:1px solid #000; margin:5px; background-color: #f8f8f8;">`;
            }
            if (firma2File) {
                const { data: urlData } = supabaseClient.storage.from('firma_cargos').getPublicUrl(`${folder.id}/firma2.png`);
                page.innerHTML += `<img src="${urlData.publicUrl}" width="200" style="border:1px solid #000; margin:5px; background-color: #f8f8f8;">`;
            }
            resultsContainer.appendChild(page);
        }
    }
</script>
</body>
</html>
