<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Firmas y Cargos v1.2</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.8"></script>
    <style>
        /* --- Estilos (sin cambios ) --- */
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #0f0f0f; color: #e0e0e0; min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .container { width: 100%; max-width: 960px; margin: 0 auto; }
        h1, h2, h3, h4 { color: #d4af37; margin-bottom: 1rem; }
        .card { background: #1a1a1a; border-radius: 12px; padding: 2.5rem; box-shadow: 0 8px 30px rgba(0,0,0,0.6); margin: 1.5rem 0; }
        input, textarea { width: 100%; padding: 12px; margin: 10px 0; background: #2a2a2a; border: 1px solid #444; border-radius: 6px; color: #e0e0e0; font-size: 1rem; }
        button { background: #d4af37; color: #0f0f0f; border: none; padding: 12px 24px; margin: 8px 4px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: all 0.2s; }
        .hidden { display: none !important; }
        .item { background: #222; padding: 1.5rem; border-radius: 10px; margin: 1.5rem 0; border-left: 4px solid #d4af37; }
        .flex-center { display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .buttons { display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; }
        
        /* --- ¡NUEVOS ESTILOS PARA LA FIRMA MEJORADA! --- */
        canvas { 
            border: 2px solid #444; 
            background: #f8f8f8; /* Fondo claro tipo papel */
            border-radius: 8px; 
            margin: 12px 0; 
            touch-action: none; /* Esencial para una buena experiencia en móvil */
            width: 100%; 
            max-width: 500px; /* Un poco más ancho para firmar cómodo */
            height: 280px;    /* Más alto también */
            box-shadow: inset 0 2px 6px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

<div class="container">
    <!-- El HTML de las vistas no cambia -->
    <div id="login-section" class="card flex-center"><!-- ... --></div>
    <div id="dashboard" class="hidden"><!-- ... --></div>
    <div id="create-folder" class="hidden"><!-- ... --></div>
    <div id="view-folder" class="hidden"><!-- ... --></div>
</div>

<script>
    // --- Código original intacto hasta loadFolder ---
    const SUPABASE_URL = 'https://esiklpxyectbekxvajnw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVzaWtscHh5ZWN0YmVreHZham53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2OTI1MjEsImV4cCI6MjA3NzI2ODUyMX0.mtQnqUrTmhmN1DQxOAUnGpizhYZobStHDH0cz_XfKGU';
    let supabaseClient = null;
    let currentUser = null;
    let items = [];
    // ... (getSupabase, window.onload, handleLogin, showDashboard, etc. sin cambios )

    // =================================================================
    // --- PRIMERA MODIFICACIÓN: Lógica de roles en loadFolder() ---
    // =================================================================
    async function loadFolder(carpeta) {
        const supabase = getSupabase();
        if (!supabase) return;

        document.getElementById('current-carpeta').textContent = carpeta;

        const { data, error } = await supabase
            .from('firmas_cargos')
            .select('*')
            .eq('carpeta', carpeta)
            .order('item');

        if (error) { alert('Error al cargar items: ' + error.message); return; }

        const container = document.getElementById('items-view');
        container.innerHTML = '';

        data.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = 'item';
            div.innerHTML = `
                <h4>${item.item}</h4>
                <p><strong>Tipo:</strong> ${item.tipo_documento}</p>
                <p><strong>Observación:</strong> ${item.observacion || '—'}</p>
                <p><strong>Estatus:</strong> ${item.estatus}</p>
                <p><strong>Firma Receptor:</strong> ${item.firma_receptor_url ? '✓ Firmado' : 'Pendiente'}</p>
                <p><strong>Firma Recepción:</strong> ${item.firma_recepcion_url ? '✓ Firmado' : 'Pendiente'}</p>
            `;

            // --- ¡NUEVA LÓGICA DE PERMISOS! ---
            const isCreator = item.created_by === currentUser.id;
            let canSign = false;
            let roleToSign = '';

            if (isCreator && !item.firma_recepcion_url) {
                // El creador puede firmar como "Recepción" si no ha firmado ya.
                canSign = true;
                roleToSign = 'recepcion';
            } else if (!isCreator && !item.firma_receptor_url) {
                // Otro usuario puede firmar como "Receptor" si no se ha firmado ya.
                canSign = true;
                roleToSign = 'receptor';
            }

            if (canSign) {
                div.innerHTML += `
                    <h5>Firmar como ${roleToSign.toUpperCase()}</h5>
                    <canvas id="canvas-${idx}"></canvas>
                    <div class="buttons">
                        <button class="secondary" onclick="clearCanvas(${idx})">Limpiar</button>
                        <button onclick="saveSignature(${idx}, ${item.id}, '${carpeta}', '${item.item}', '${roleToSign}')">Guardar Firma</button>
                    </div>
                `;
            }
            // --- FIN DE LA LÓGICA DE PERMISOS ---

            container.appendChild(div);
            if (canSign) {
                setTimeout(() => initCanvas(idx), 150); // Inicializar canvas solo si se puede firmar
            }
        });

        document.getElementById('dashboard').classList.add('hidden');
        document.getElementById('create-folder').classList.add('hidden');
        document.getElementById('view-folder').classList.remove('hidden');
    }

    // =================================================================
    // --- SEGUNDA MODIFICACIÓN: Firma mejorada en initCanvas() ---
    // =================================================================
    function initCanvas(idx) {
        const canvas = document.getElementById(`canvas-${idx}`);
        if (!canvas) return;

        const ctx = canvas.getContext('2d');
        // Ajustar el tamaño del canvas para mayor resolución
        const dpr = window.devicePixelRatio || 1;
        canvas.width = canvas.offsetWidth * dpr;
        canvas.height = canvas.offsetHeight * dpr;
        ctx.scale(dpr, dpr);

        ctx.strokeStyle = '#000000'; // Color negro clásico de firma
        ctx.lineCap = 'round';       // Puntas redondeadas para suavidad
        ctx.lineJoin = 'round';      // Uniones de línea redondeadas

        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let lastTime = 0;
        let lastLineWidth = 2; // Grosor inicial

        function getPosition(e) {
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX || (e.touches && e.touches[0].clientX)) - rect.left;
            const y = (e.clientY || (e.touches && e.touches[0].clientY)) - rect.top;
            return { x, y };
        }

        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();

            const pos = getPosition(e);
            const currentTime = Date.now();
            const timeDiff = currentTime - lastTime || 1;

            // Calcular velocidad para el grosor dinámico
            const distance = Math.sqrt(Math.pow(pos.x - lastX, 2) + Math.pow(pos.y - lastY, 2));
            const velocity = distance / timeDiff;
            
            // El grosor será inversamente proporcional a la velocidad (más rápido = más fino)
            // Ajustamos los valores para que se sienta bien con el dedo
            const lineWidth = Math.max(1.5, Math.min(5.0, 5.0 - velocity * 1.5));

            ctx.lineWidth = (lineWidth + lastLineWidth) / 2; // Suavizar la transición de grosor

            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();

            lastX = pos.x;
            lastY = pos.y;
            lastTime = currentTime;
            lastLineWidth = lineWidth;
        }

        function startDrawing(e) {
            e.preventDefault();
            isDrawing = true;
            const pos = getPosition(e);
            [lastX, lastY] = [pos.x, pos.y];
            lastTime = Date.now();
            lastLineWidth = 2;
            
            // Dibuja un punto inicial para que el trazo no empiece de la nada
            ctx.beginPath();
            ctx.arc(pos.x, pos.y, lastLineWidth / 2, 0, Math.PI * 2);
            ctx.fillStyle = '#000000';
            ctx.fill();
        }

        function stopDrawing() {
            isDrawing = false;
            ctx.beginPath();
        }

        // Eventos de mouse
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);

        // Eventos táctiles para celulares/tablets
        canvas.addEventListener('touchstart', startDrawing);
        canvas.addEventListener('touchmove', draw);
        canvas.addEventListener('touchend', stopDrawing);
        canvas.addEventListener('touchcancel', stopDrawing);
    }

    // --- Resto del código (sin cambios) ---
    // ... (clearCanvas, saveSignature, dataURLtoBlob, backToDashboard)
</script>
</body>
</html>
