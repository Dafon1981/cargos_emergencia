<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App de Firmas y Cargos</title>
     <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.8"></script>
    <style>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f4f4; padding: 20px; }
        .hidden { display: none; }
        canvas { border: 1px solid #000; background: #fff; }
        button { margin: 5px; }
        input, textarea { margin: 5px; width: 300px; }
        .item { border: 1px solid #ccc; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>

    <!-- Sección de Login -->
    <div id="login-section">
        <h1>Iniciar Sesión</h1>
        <form id="login-form">
            <label for="usuario">Usuario:</label><br>
            <input type="text" id="usuario" required><br>
            <label for="clave">Clave:</label><br>
            <input type="password" id="clave" required><br>
            <button type="button" onclick="handleLogin()">Iniciar Sesión</button>
        </form>
    </div>

    <!-- Dashboard después de login -->
    <div id="dashboard" class="hidden">
        <h1>Bienvenido, <span id="username"></span></h1>
        <button onclick="showCreateFolder()">Crear Nueva Carpeta</button>
        <button onclick="loadFolders()">Consultar Carpetas</button>
        <div id="folders-list"></div>
    </div>

    <!-- Sección para crear carpeta -->
    <div id="create-folder" class="hidden">
        <h2>Crear Carpeta</h2>
        <label for="carpeta">Nombre de Carpeta (ej: cargosemergencia2024/30/01):</label><br>
        <input type="text" id="carpeta" required><br>
        <h3>Agregar Items</h3>
        <div id="items-container"></div>
        <button onclick="addItemField()">Agregar Item</button>
        <button onclick="createFolderAndItems()">Guardar Carpeta e Items</button>
        <button onclick="backToDashboard()">Volver</button>
    </div>

    <!-- Sección para ver carpeta -->
    <div id="view-folder" class="hidden">
        <h2>Carpeta: <span id="current-carpeta"></span></h2>
        <div id="items-view"></div>
        <button onclick="backToDashboard()">Volver</button>
    </div>

    <script>
        const supabaseUrl = 'https://esiklpxyectbekxvajnw.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVzaWtscHh5ZWN0YmVreHZham53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2OTI1MjEsImV4cCI6MjA3NzI2ODUyMX0.mtQnqUrTmhmN1DQxOAUnGpizhYZobStHDH0cz_XfKGU';
        const supabase = supabasejs.createClient(supabaseUrl, supabaseKey);

        let currentUser = null;
        let items = []; // Array temporal para items al crear carpeta

        // Función para login (custom, ya que usa tabla usuarios)
        async function handleLogin() {
            const usuario = document.getElementById('usuario').value;
            const clave = document.getElementById('clave').value;

            const { data, error } = await supabase
                .from('usuarios')
                .select('*')
                .eq('usuario', usuario)
                .eq('clave', clave)
                .single();

            if (error || !data) {
                alert('Error en login: ' + (error ? error.message : 'Credenciales inválidas'));
                return;
            }

            currentUser = data;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('username').textContent = currentUser.usuario;
        }

        // Cargar usuario de localStorage si existe
        window.onload = () => {
            const storedUser = localStorage.getItem('currentUser');
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                document.getElementById('username').textContent = currentUser.usuario;
            }
        };

        // Mostrar sección de crear carpeta
        function showCreateFolder() {
            items = [];
            document.getElementById('items-container').innerHTML = '';
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('create-folder').classList.remove('hidden');
        }

        // Agregar campo para nuevo item
        function addItemField() {
            const index = items.length;
            const div = document.createElement('div');
            div.classList.add('item');
            div.innerHTML = `
                <label>Item (ej: e20243001A):</label><br>
                <input type="text" id="item-${index}" required><br>
                <label>Tipo de Documento:</label><br>
                <input type="text" id="tipo-${index}" required><br>
                <label>Observación:</label><br>
                <textarea id="obs-${index}"></textarea><br>
            `;
            document.getElementById('items-container').appendChild(div);
            items.push(index);
        }

        // Crear carpeta e items en la tabla
        async function createFolderAndItems() {
            const carpeta = document.getElementById('carpeta').value;
            if (!carpeta || items.length === 0) {
                alert('Debe ingresar carpeta y al menos un item');
                return;
            }

            for (let i = 0; i < items.length; i++) {
                const itemCode = document.getElementById(`item-${i}`).value;
                const tipo = document.getElementById(`tipo-${i}`).value;
                const obs = document.getElementById(`obs-${i}`).value;

                const { error } = await supabase
                    .from('firmas_cargos')
                    .insert({
                        carpeta: carpeta,
                        item: itemCode,
                        tipo_documento: tipo,
                        observacion: obs,
                        created_by: currentUser.id,
                        estatus: 'pendiente'
                    });

                if (error) {
                    alert('Error al insertar item: ' + error.message);
                    return;
                }
            }

            alert('Carpeta e items creados exitosamente. Ahora puedes firmar como recepcionista.');
            loadFolder(carpeta); // Ir a ver la carpeta para firmar
        }

        // Cargar lista de carpetas (distinct)
        async function loadFolders() {
            const { data, error } = await supabase
                .from('firmas_cargos')
                .select('carpeta')
                .distinct();

            if (error) {
                alert('Error al cargar carpetas: ' + error.message);
                return;
            }

            const list = document.getElementById('folders-list');
            list.innerHTML = '<h3>Carpetas Disponibles</h3>';
            data.forEach(folder => {
                const btn = document.createElement('button');
                btn.textContent = folder.carpeta;
                btn.onclick = () => loadFolder(folder.carpeta);
                list.appendChild(btn);
            });
        }

        // Cargar items de una carpeta y mostrar firmas
        async function loadFolder(carpeta) {
            document.getElementById('current-carpeta').textContent = carpeta;
            const { data, error } = await supabase
                .from('firmas_cargos')
                .select('*')
                .eq('carpeta', carpeta);

            if (error) {
                alert('Error al cargar items: ' + error.message);
                return;
            }

            const view = document.getElementById('items-view');
            view.innerHTML = '';
            data.forEach((itemData, index) => {
                const div = document.createElement('div');
                div.classList.add('item');
                div.innerHTML = `
                    <h4>Item: ${itemData.item}</h4>
                    <p>Tipo: ${itemData.tipo_documento}</p>
                    <p>Observación: ${itemData.observacion || 'Ninguna'}</p>
                    <p>Estatus: ${itemData.estatus}</p>
                    <p>Firma Receptor: ${itemData.firma_receptor_url ? 'Firmado' : 'Pendiente'}</p>
                    <p>Firma Recepcion: ${itemData.firma_recepcion_url ? 'Firmado' : 'Pendiente'}</p>
                `;

                // Determinar rol: si es creator, firma como recepcion; else como receptor
                const isCreator = itemData.created_by === currentUser.id;
                const role = isCreator ? 'recepcion' : 'receptor';
                const alreadySigned = isCreator ? !!itemData.firma_recepcion_url : !!itemData.firma_receptor_url;

                if (!alreadySigned) {
                    div.innerHTML += `
                        <h5>Firmar como ${role}</h5>
                        <canvas id="canvas-${index}" width="400" height="200"></canvas><br>
                        <button onclick="clearCanvas(${index})">Limpiar</button>
                        <button onclick="saveSignature(${index}, '${itemData.id}', '${carpeta}', '${itemData.item}', '${role}')">Guardar Firma</button>
                    `;
                }

                view.appendChild(div);
            });

            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('create-folder').classList.add('hidden');
            document.getElementById('view-folder').classList.remove('hidden');

            // Inicializar canvases después de render
            data.forEach((_, index) => initCanvas(index));
        }

        // Inicializar canvas para dibujo
        function initCanvas(index) {
            const canvas = document.getElementById(`canvas-${index}`);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            let drawing = false;

            canvas.addEventListener('mousedown', () => { drawing = true; });
            canvas.addEventListener('mouseup', () => { drawing = false; ctx.beginPath(); });
            canvas.addEventListener('mousemove', (e) => {
                if (drawing) {
                    ctx.lineTo(e.offsetX, e.offsetY);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(e.offsetX, e.offsetY);
                }
            });
        }

        // Limpiar canvas
        function clearCanvas(index) {
            const canvas = document.getElementById(`canvas-${index}`);
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        // Guardar firma: subir a storage y actualizar tabla
        async function saveSignature(index, itemId, carpeta, itemCode, role) {
            const canvas = document.getElementById(`canvas-${index}`);
            const dataURL = canvas.toDataURL('image/png');
            const blob = dataURLtoBlob(dataURL);
            const path = `${carpeta}/${itemCode}_${role}.png`;

            const { error: uploadError } = await supabase.storage
                .from('firma_cargos')
                .upload(path, blob, { contentType: 'image/png' });

            if (uploadError) {
                alert('Error al subir firma: ' + uploadError.message);
                return;
            }

            const { publicUrl } = supabase.storage.from('firma_cargos').getPublicUrl(path).data;

            const updateData = {};
            if (role === 'recepcion') {
                updateData.firma_recepcion_url = publicUrl;
                updateData.signed_by_recepcion = currentUser.id;
            } else {
                updateData.firma_receptor_url = publicUrl;
                updateData.signed_by_receptor = currentUser.id;
            }

            // Actualizar estatus si ambas firmas están
            if (updateData.firma_recepcion_url && updateData.firma_receptor_url) {
                updateData.estatus = 'completado';
            } else if (updateData.firma_recepcion_url || updateData.firma_receptor_url) {
                updateData.estatus = 'firmado_parcial';
            }

            const { error: updateError } = await supabase
                .from('firmas_cargos')
                .update(updateData)
                .eq('id', itemId);

            if (updateError) {
                alert('Error al actualizar firma: ' + updateError.message);
            } else {
                alert('Firma guardada exitosamente.');
                loadFolder(carpeta); // Recargar vista
            }
        }

        // Convertir dataURL a Blob
        function dataURLtoBlob(dataurl) {
            let arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
                bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
            while (n--) {
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new Blob([u8arr], { type: mime });
        }

        // Volver al dashboard
        function backToDashboard() {
            document.getElementById('create-folder').classList.add('hidden');
            document.getElementById('view-folder').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('folders-list').innerHTML = '';
        }
    </script>
</body>
</html>

